{% extends 'collabrate/base.html' %}
{% block title %}Dashboard{% endblock %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'course/course_landing.css' %}">
<link rel="stylesheet" href="{% static 'course/sidenav.css' %}">
{% endblock %}

{% block content %}
<div class="d-flex">
    {% include "course/sidenav.html" %}

    {% if user.user_type == "student" %}
    {% if team_forms %}
    <div class="main-container p-4">
        <div style="flex: 0 0  8.5%;">
            <div class="pb-3">
                <h1>
                    {{ course.code }} <strong>|</strong> {{ course.title }}
                </h1>
            </div>
            <hr class="m-0 pb-4" style="opacity: 100%;">
        </div>
        {% for grp in team_forms %}
        <h2 class="section-title">Team: {{ grp.team.name }}</h2>

        <h3>To Do</h3>
        {% if grp.todo_forms %}
        {% for form in grp.todo_forms %}
        <a href="{% url 'answer_form' join_code=course.join_code form_id=form.id %}"
            style="text-decoration:none; color:inherit;">
            <div class="card">
                <div class="info">
                    <p>{{ form.name }} | {{ grp.team.name }}</p>
                    <small
                        class="card-text due-datetime"
                        data-due-datetime="{{ form.due_datetime|date:'c' }}"
                    >
                        <!-- will be filled in by JS -->
                    </small>
                </div>
                <span class="dot red"></span>
            </div>
        </a>
        {% endfor %}
        {% else %}
        <p>No forms assigned to {{ grp.team.name }}.</p>
        {% endif %}

        <h3>Feedback</h3>
        {% if grp.released_forms %}
        {% for form in grp.released_forms %}
        <a href="{% url 'peer_results' join_code=course.join_code form_id=form.id %}"
            class="text-decoration-none text-reset">
            <div class="card">
                <div class="info">
                    <p>{{ form.name }} | {{ grp.team.name }}</p>
                </div>
                <span class="dot green"></span>
            </div>
        </a>
        {% endfor %}
        {% else %}
        <p>No feedback released for {{ grp.team.name }} yet.</p>
        {% endif %}

        {% endfor %}
    </div>
    {% else %}
    <div class="main-container">
        <div class="course-header" style="background-color: {{ course.color }};">
            <b>{{ course.code }}</b> | {{ course.title }}
        </div>
        <p class="mt-4">You are <strong>not</strong> assigned to a team yet.</p>
    </div>
    {% endif %}
    {% else %}
    <!-- Professor view - unchanged from original -->
    <div class="main-container">
        <h1>Hello professor!</h1>
        <button><a href="{% url 'create_team' course.join_code %}">Create/Manage Teams</a></button>
        <button><a href="{% url 'create_form' course.join_code %}">Create Form</a></button>
        <form method="POST" action="{% url 'clear_course_forms' course.join_code %}">
            {% csrf_token %}
            <button type="submit">Clear ALL Course Forms/Questions (TESTING PURPOSES)</button>
        </form>

    </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // find every element with that class
        document.querySelectorAll(".due-datetime").forEach(el => {
        const iso = el.dataset.dueDatetime;  
        if (!iso) return;

        const dt = new Date(iso);

        // e.g. “April 30, 2025”
        const date = dt.toLocaleDateString(undefined, {
            month: "long",
            day:   "numeric",
            year:  "numeric"
        });

        // e.g. “3:20 PM”
        const time = dt.toLocaleTimeString(undefined, {
            hour:   "numeric",
            minute: "2-digit",
            hour12: true
        });

        el.textContent = `Due: ${date} at ${time}`;
        });
    });
</script>
{% endblock %}